<th:block th:replace="layout :: setContent(~{this::content})">
    <th:block th:fragment="content">
        <!DOCTYPE html>
        <html xmlns:th="http://www.thymeleaf.org" lang="en">
        <head>
            <link href="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-bs5.min.css" rel="stylesheet">
            <script src="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-bs5.min.js"></script>
            <link rel="stylesheet" th:href="@{/css/boardHome.css}">
            <style>
                form[name=boardform] {
                    padding: 30px 60px 10px;
                }

                h1 {
                    font-size: 1.5rem;
                    text-align: center;
                    color: #1a92b9
                }

                label {
                    font-weight: bold
                }

                #upfile {
                    display: none
                }

                img {
                    width: 20px;
                }

                .attachFile {
                    border: 1px dashed;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 80px;
                    width: 85%;
                    border-radius: 10px;
                }

                .fileLabel {
                    margin: 0px 3px;
                    cursor: pointer;
                }

                .file-list {
                    display: none;
                    height: 130px;
                    overflow: auto;
                    border: 1px solid #989898;
                    padding: 10px;
                    margin: 0px 0px 1rem 15%;
                    border-radius: 10px;
                }

                .file-list .filebox p {
                    font-size: 14px;
                    margin-top: 10px;
                    display: inline-block;
                }

                .file-list .filebox .delete i {
                    color: #ff5353;
                    margin-left: 5px;
                }

                .form-group2, .form-group2-file {
                    margin-bottom: 1rem;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                }

                .boardName {
                    word-wrap: normal;
                    padding: 5px 15vh 5px 3px;
                    margin: 0px 5px;
                    font-size: 18px;
                    width: 300px;
                    border: 1px solid #ccc;
                    border-radius: 7px;
                }

                .form-control2 {
                    width: 85%;
                }

                .form-group-btn {
                    display: flex;
                    justify-content: center;
                    height: 70px;
                    align-items: center;
                    margin-top: 10px;
                }

                .registerBtn {
                    width: 100px;
                    background: white;
                    color: #7f7f7f;
                    border: 1.5px solid #9d9c9c;
                    font-weight: bolder;
                }

                .labelName {
                    margin: 0px;
                    font-size: 18px;
                    font-weight: 600;
                    padding: 0px 0px 0px 10px;
                }

                .dragoverFile {
                    border: 3px solid #334466;
                    z-index: 1;
                }

                .hidden {
                    display: block;
                }

            </style>
            <script th:src="@{/js/writeform.js}"></script>
            <script th:inline="javascript">
                var fileNo = 0;
                var filesArr = [];
                var maxFileCnt = 5;   // 첨부파일 최대 개수

                let boardMap = /*[[${boardMap}]]*/ {};

                /* 첨부파일 추가 */
                function addFiles(files) {
                    var attFileCnt = $('.filebox').length;
                    var remainFileCnt = maxFileCnt - attFileCnt;
                    var curFileCnt = files.length;

                    if (curFileCnt > remainFileCnt) {
                        alert("첨부파일은 최대 " + maxFileCnt + "개 까지 첨부 가능합니다.");
                        return;
                    }

                    for (const file of files) {
                        if (validation(file)) {
                            fileListAppendHtml(file);// fileList 추가
                        }
                    }

                    updateFileListVisibility();
                    $("input:file").val(""); // 파일 입력 필드 초기화
                }

                //addFile과 handleFiles에서 공통된 파일 처리 로직
                function addFile(obj) {
                    addFiles(obj.files);
                }

                function handleFiles(dragFiles) {
                    addFiles(dragFiles);
                }

                /* fileList html 추가 */
                function fileListAppendHtml(file) {
                    // 파일 객체에 고유 fileNo 값을 추가해 배열에 저장
                    file.fileNo = fileNo;
                    filesArr.push(file);

                    // 목록 추가
                    let htmlData = '';
                    htmlData += '<div id="file' + fileNo + '" class="filebox">';
                    htmlData += '   <p class="name">' + file.name + '</p>';
                    htmlData += '   <a class="delete" onclick="deleteFile(' + fileNo + ');"><img src="/image/delete.png"/></a>';
                    htmlData += '</div>';
                    $('.file-list').append(htmlData);

                    fileNo++; // 값 증가
                }

                /* 첨부파일 검증 */
                function validation(file) {
                    const maxSize = 100 * 1024 * 1024; // 100MB
                    if (file.name.length > 100) {
                        alert("파일명이 100자 이상인 파일은 제외되었습니다.");
                    } else if (file.size > maxSize) {
                        alert("최대 파일 용량인 100MB를 초과한 파일은 제외되었습니다.");
                    } else if (!file.name.includes('.')) {
                        alert("확장자가 없는 파일은 제외되었습니다.");
                    } else {
                        return true;
                    }
                    return false;
                }

                /* 첨부파일 삭제 */
                function deleteFile(deleteNo) {

                    // filesArr 배열에서 삭제할 파일을 fileNo로 찾음
                    filesArr = filesArr.filter(file => file.fileNo !== deleteNo);

                    // 파일 목록에서 삭제
                    $("#file" + deleteNo).remove();

                    // 파일 목록이 비어 있으면 숨김 처리
                    updateFileListVisibility();
                }

                /* 파일 목록이 비어있으면 숨김 처리 */
                function updateFileListVisibility() {
                    $('.file-list').toggleClass('hidden', filesArr.length !== 0);
                }

                // function submitForm() {
                //     // let content = $('.summernote').summernote('code');
                //     // var form = document.querySelector("form[name='boardform']");
                //     // var formData = new FormData(form);
                //
                //     // 이미지 업로드를 위한 FormData 생성
                //     let imageFormData = new FormData();
                //     uploadedFiles.forEach(file => {
                //         imageFormData.append("images", file);
                //     });
                //
                //     // AJAX로 이미지 업로드
                //     $.ajax({
                //         method: 'POST',
                //         url: 'upload',
                //         data: imageFormData,
                //         processData: false,
                //         contentType: false,
                //         success: function (response) {
                //             if (response.urls && response.urls.length === uploadedFiles.length) {
                //                 // 기존의 <img> 태그의 src를 업로드된 URL로 변경
                //                 $('.summernote').next().find('img').each((index, img) => {
                //                     let src = $(img).attr('src');
                //                     if (src.startsWith('data:')) { // base64 이미지인 경우 변경
                //                         $(img).attr('src', response.urls[index]); // 새로운 URL 적용
                //                     }
                //                 });
                //
                //                 // 수정된 내용으로 폼 제출
                //                 submitPost();
                //             }
                //         }
                //     });
                // }

                // function submitForm() {
                //     let imageFormData = new FormData();
                //
                //     console.log("uploadedFiles 배열:", uploadedFiles);
                //     uploadedFiles.forEach(file => console.log(file, file instanceof File));
                //
                //     // 업로드할 이미지 파일을 FormData에 추가
                //     uploadedFiles.forEach((file, index) => {
                //         imageFormData.append("images", file);
                //     });
                //
                //     // FormData 내부에 파일이 잘 들어갔는지 확인
                //     for (let pair of imageFormData.entries()) {
                //         console.log(pair[0], pair[1]);  // 콘솔에 추가된 파일 출력
                //     }
                //
                //     // AJAX 요청
                //     $.ajax({
                //         method: 'POST',
                //         url: '/board/post/upload',
                //         data: imageFormData,
                //         processData: false,
                //         contentType: false,
                //         success: function (response) {
                //             console.log("✅ 업로드 성공: ", response.urls);
                //         },
                //         error: function (xhr) {
                //             console.error("❌ 업로드 실패:", xhr.responseText);
                //         }
                //     });
                // }

                /* 폼 전송 */
                function submitForm() {
                    var form = document.querySelector("form[name='boardform']");
                    var formData = new FormData(form);

                    uuidList.forEach(uuid => {
                        formData.append("uuidList", uuid);
                    })

                    uploadedFiles.forEach(file => {
                        formData.append("images", file);
                    });

                    // 삭제되지 않은 파일만 폼데이터에 담기
                    filesArr.forEach(file => {
                        formData.append("attachFiles", file);
                    });

                    for (let [key, value] of formData.entries()) {
                        if (key === 'files') {
                            formData.delete(key);
                            console.log("delete = ", key)
                        }
                        console.log(key, value);
                    }

                    $.ajax({
                        method: 'POST',
                        url: 'add',
                        dataType: 'json',
                        data: formData,
                        processData: false,
                        contentType: false,
                        cache: false,
                        success: function (data) {
                            console.log("data.postId=", data.postId)
                            if (data === "" || data.postId === -1) {
                                alert('게시글이 작성 중 오류가 발생하였습니다.');
                                return location.href = "/board/home";
                            }
                            alert('게시글이 작성되었습니다.');
                            return location.href = `/board/post/detail?no=${data.postId}&boardName1=${encodeURIComponent(data.boardDTO.boardName1)}&boardName2=${encodeURIComponent(data.boardDTO.boardName2)}&page=1`;
                        },
                        error: function (xhr, desc, err) {
                            alert('에러가 발생하였습니다.');
                            location.href = "/board/home";
                        }
                    });
                }

                //boardName2를 boardName1에 맞게 바꿈
                function changeBoardName2(boardName1Value, companyBoards, generalBoards, departmentBoards) {
                    let $boardName2 = $('#boardName2'); // 두 번째 select 초기화
                    $boardName2.empty();

                    if (boardName1Value === '전사게시판') {
                        $.each(companyBoards, function (index, companyBoard) {
                            $boardName2.append('<option value="' + companyBoard + '">' + companyBoard + '</option>');
                        });
                    } else if (boardName1Value === '일반게시판') {
                        $.each(generalBoards, function (index, generalBoard) {
                            $boardName2.append('<option value="' + generalBoard + '">' + generalBoard + '</option>');
                        });
                    } else if (boardName1Value === '부서게시판') {
                        $.each(departmentBoards, function (index, departmentBoard) {
                            $boardName2.append('<option value="' + departmentBoard + '">' + departmentBoard + '</option>');
                        });
                    }
                }

                function filterBoardName2(boardName1) {
                    let filteredArray = []; // 결과를 담을 배열
                    for (const value of boardMap[boardName1]) {
                        console.log("value = ", value)
                        filteredArray.push(value);
                    }
                    return filteredArray;
                }

                $(function () {
                    let companyBoards = filterBoardName2('전사게시판');
                    let generalBoards = filterBoardName2('일반게시판');
                    let departmentBoards = filterBoardName2('부서게시판');

                    var BoardName2Value = $('#boardName2Hidden').val();
                    let boardName1Value;

                    if (BoardName2Value === '' || BoardName2Value == null) {//게시판 홈에서 글쓰기 버튼을 누를 경우 초기화
                        BoardName2Value = '공지사항';
                    }

                    // BoardName2Text의 따라 BoardName1 구하기
                    if (companyBoards.includes(BoardName2Value)) {
                        boardName1Value = '전사게시판';
                    } else if (departmentBoards.includes(BoardName2Value)) {
                        boardName1Value = '부서게시판';
                    } else {
                        boardName1Value = '일반게시판';
                    }

                    changeBoardName2(boardName1Value, companyBoards, generalBoards, departmentBoards);//boardName2를 boardName1에 맞게 바꿈
                    $('#boardName1').val(boardName1Value);
                    $('#boardName2').val(BoardName2Value);

                    // $(".boardName2,.left a").removeClass('menuActive');

                    //boardName1 select를 바꿀때마다 boardName2가 같이 바뀜
                    $('#boardName1').change(function () {
                        let boardName1Value = $(this).val();  // 첫 번째 select의 선택 값

                        changeBoardName2(boardName1Value, companyBoards, generalBoards, departmentBoards);//boardName2를 boardName1에 맞게 바꿈
                    });


                    // dragover 이벤트: 드래그한 파일이 attachFlie 영역에 있을 때
                    $('.attachFile, .file-list').on('dragover', function (event) {
                        event.preventDefault();
                        $(this).addClass('dragoverFile');
                    });

                    $('.attachFile, .file-list').on('dragleave', function () {
                        $(this).removeClass('dragoverFile');
                    });

                    $('.attachFile, .file-list').on('drop', function (event) {
                        event.preventDefault();  // 기본 동작을 취소
                        $(this).removeClass('dragoverFile');

                        var dragFiles = event.originalEvent.dataTransfer.files;  // 드롭된 파일들
                        handleFiles(dragFiles);  // 드래그된 파일 처리
                    });

                });

                //Drop 영역외에 파일 끌어다 놓았을 때 브라우져 동작막깅
                document.addEventListener("dragover", function (event) {
                    event.preventDefault();
                });

                document.addEventListener("drop", function (event) {
                    event.preventDefault();
                });
            </script>
        </head>
        <body>
        <div class="main">
            <th:block th:replace="~{board/sidebar :: boardSidebarFragment}"/>

            <div class="content">
                <div class="boardTitle">글쓰기</div>
                <div class="boardContent">
                    <form method="post" enctype="multipart/form-data"
                          name="boardform" onsubmit="event.preventDefault(); submitForm();">
                        <div class="form-group2 form-group2-title">
                            <input type="hidden" id="boardName2Hidden" name="boardName2Hidden"
                                   th:value='${boardName2}'/>
                            <label class="labelName">
                                To.
                                <select id="boardName1" name="boardName1" class="boardName">
                                    <option value="전사게시판" th:if="${boardName1 == '전사게시판' ? 'selected' : ''}">전사게시판
                                    </option>
                                    <option value="일반게시판" th:if="${boardName1 == '일반게시판' ? 'selected' : ''}">일반게시판
                                    </option>
                                    <option value="부서게시판" th:if="${boardName1 == '부서게시판' ? 'selected' : ''}">부서게시판
                                    </option>
                                </select>
                                <select id="boardName2" name="boardName2" class="boardName">
                                    <option value="공지사항" th:if="${boardName2 == '공지사항' ? 'selected' : ''}">공지사항</option>
                                    <option value="주간식단표" th:if="${boardName2 == '주간식단표' ? 'selected' : ''}">주간식단표
                                    </option>
                                    <option value="FAQ" th:if="${boardName2 == 'FAQ' ? 'selected' : ''}">FAQ</option>
                                </select>
                            </label>
                        </div>
                        <div class="form-group2">
                            <label for="board_subject" class="labelName">제목</label>
                            <input name="postSubject" id="board_subject" type="text" maxlength="100"
                                   class="form-control2" placeholder="제목을 입력하세요" style="padding-left: 10px;" required>
                        </div>
                        <div class="form-group2-file">
                            <label class="labelName">파일첨부</label>
                            <div class="attachFile">
                                <img th:src="@{/image/attach.png}" alt="파일첨부">
                                이 곳에 파일을 드래그 하세요. 또는
                                <label class="fileLabel">
                                    파일선택
                                    <input type="file" name="files" id="upfile" onchange="addFile(this);" multiple/>
                                </label>
                            </div>
                        </div>
                        <div class="file-list"></div>
                        <textarea class="summernote form-control2" id="board_content" name="postContent"
                                  required></textarea>
                        <div class="form-group-btn">
                            <button type="submit" class="btn registerBtn">등록</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <script>
            let uploadedFiles = []; // 사용자가 업로드한 파일들을 저장할 배열
            let uuidList = [];

            $(document).ready(function () {
                $('.summernote').summernote({
                    height: 400,
                    minHeight: 400,
                    maxHeight: null,
                    lang: 'ko-KR',
                    toolbar: [
                        ['fontname', ['fontname']],
                        ['fontsize', ['fontsize']],
                        ['style', ['bold', 'italic', 'underline', 'strikethrough', 'clear']],
                        ['color', ['forecolor', 'color']],
                        ['table', ['table']],
                        ['para', ['ul', 'ol', 'paragraph']],
                        ['height', ['height']],
                        ['insert', ['picture', 'link']],
                        ['view', ['fullscreen', 'help']]
                    ],
                    fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', '맑은 고딕', '궁서', '굴림체', '굴림', '돋움체', '바탕체'],
                    fontSizes: ['8', '9', '10', '11', '12', '14', '16', '18', '20', '22', '24', '28', '30', '36', '50', '72'],
                    focus: true,
                    callbacks: {
                        onImageUpload: function (files) {
                            let imageFormData = new FormData();

                            // 여러 파일을 처리하기 위해 반복문을 사용
                            for (let file of files) {
                                imageFormData.append("images", file);  // 여러 이미지 파일을 FormData에 추가
                            }

                            $.ajax({
                                url: "/board/post/upload", // 이미지 업로드 처리 서버 URL
                                type: "POST",
                                data: imageFormData,
                                processData: false,
                                contentType: false,
                                success: function (response) {
                                    // 서버에서 반환된 URL을 배열로 받음 (여러 이미지 처리)
                                    let imageUrls = response.urls;
                                    uuidList = response.uuidList;

                                    // 업로드된 각 이미지의 URL을 Summernote에 삽입
                                    for (let i = 0; i < files.length; i++) {
                                        let img = $('<img>')
                                            .attr('src', imageUrls[i]) // 서버에서 받은 URL
                                            .attr('data-filename', files[i].name) // 파일명을 저장
                                            .css('width', '70%');

                                        $('.summernote').summernote('insertNode', img[0]);
                                        uploadedFiles.push(files[i]); // 업로드된 파일을 배열에 추가
                                    }

                                    console.log("📂 현재 uploadedFiles:", uploadedFiles);
                                },
                                error: function () {
                                    alert("이미지 업로드 실패");
                                }
                            });
                        },
                        onImageDelete: function (target) {
                            console.log("삭제 요청 중");
                            let deletedFilename = $(target).attr('data-filename'); // ✅ 삭제할 이미지 파일명 추출
                            console.log("🗑 삭제 요청된 파일:", deletedFilename);

                            // ✅ 파일명으로 `uploadedFiles`에서 제거
                            uploadedFiles = uploadedFiles.filter(file => file.name !== deletedFilename);
                            console.log("📂 업데이트된 uploadedFiles:", uploadedFiles);
                        }
                    }
                });

                $('.boardContent .active').removeClass('active');
            });
        </script>
        </body>
        </html>
    </th:block>
</th:block>